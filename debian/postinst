#!/bin/bash

pre_inst_checksums="/tmp/pre-inst-plugins-checksum.chk"
post_inst_checksums="/tmp/post-inst-plugins-checksum.chk"

runPostInstChecksums() {
    echo -e "\nGenerating Kong plugins post-install checksums..."
    find /opt/kong/plugins -print0 2>/dev/null -type f -exec sha1sum "{}" + > "$post_inst_checksums"
}

assertDockerComposeIsInstalledAndExitIfNeeded() {
    which docker-compose
    if [[ $? -ne 0 ]]; then
        echo -e "\ndocker-compose isn't installed cannot restart Kong"
        current_time=$(date "+%Y.%m.%d-%H.%M.%S")
        echo "Kong is pending to be restarted because plugins changed - $current_time" > /opt/kong/kong-pending-restart.log
        exit 0
    fi
}

restartKongIfNeeded() {
    if [[ `docker-compose ps --services --filter "status=running" | grep kong` ]]; then
        docker-compose restart kong
    else
        echo "Kong service is not running. Restart was skipped."
    fi
}

compareChecksumsAndRestartKongIfneeded() {
    if cmp --silent -- "$post_inst_checksums" "$pre_inst_checksums"; then
        echo "Previous plugin files are identical to the new ones, avoiding restart"
    else
        echo "Plugins were updated/installed, restarting kong"
        cd /opt/kong
        assertDockerComposeIsInstalledAndExitIfNeeded
        restartKongIfNeeded
    fi
}

runPostInstChecksums
compareChecksumsAndRestartKongIfneeded
