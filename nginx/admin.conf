# This will parse the Subject DN with Regex, then extract the CN
# Into a new variable called ssl_client_s_dn_cn that is used latter
map $ssl_client_s_dn $ssl_client_s_dn_cn {
  default "";
  ~CN=(?<CN>[^,]+) $CN;
}

server {
  listen 80;
  include /etc/nginx/conf.d/server_hosts/admin-url.conf;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;
  include /etc/nginx/conf.d/server_hosts/admin-url.conf;
  include /etc/nginx/conf.d/sslCertificates.conf;

  ssl_client_certificate /etc/nginx/conf.d/certs_for_client_auth/CA-cert.pem;
  ssl_verify_client on;
  ssl_verify_depth 1;

  location / {
    proxy_set_header X-test-header 'test-data';
    proxy_set_header X-test-header-cn $ssl_client_s_dn_cn;
    proxy_pass http://kong:8000/admin-api;
    error_log /var/log/admin_error.log;
  }
}
